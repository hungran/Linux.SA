# Phần 1. Quy trình khởi động Linux/UNIX
 Quy trình khởi động Linux/UNIX được diễn ra tính từ thời điểm bật máy "Power-On" và theo lần lượt như bảng dưới
 
 <img src="https://imgur.com/XjpWlE0.jpg">
 Mặc dù đây là quy trình tiêu chuẩn cho bất kì hệ thống Linux nào tuy nhiên cũng đã có sự thay đổi khi các hệ thống di chuyển lên các dịch vụ điện toán đám mây, container. Các quản trị viên có thể quản lý quá trình này bằng một số công cụ hình ảnh, API, bảng điều khiển thay vì chạm vào phần cứng vật lý.
 Để dễ hình dung các bước ta có bảng như sau:
 
  |Bước|   |
  | --- | --- |
  | Bước 1 | BIOS/UEFI (system firmware) |
  | Bước 2 | Kiểm tra phần cứng |
  | Bước 3 | Chọn nguồn khởi động (từ ổ đĩa, mạng,..) |
  | Bước 4 | Xác định phân vùng EFI |
  | Bước 5 | Load boot loader |
  | Bước 6 | Xác định nhân Linux |
  | Bước 7 | Load nhân |
  | Bước 8 | Khởi tạo nhân |
  | Bước 9 | Khởi chạy tiến trình số 1 |
  | Bước 10 | Thực thi các lệnh ban đầu |
  | Bước 11 | Hệ thống chạy |
  
   
 ** BIOS / UEFI (system firmware)
 Khi một máy tính Linux được bật, việc đầu tiên CPU sẽ thực thi các dòng lệnh được chứa trong ROM (bộ nhớ chỉ đọc)
 Chương trình này được gọi là `system firmware`, `system firmware` được biết đến là `BIOS`
 Với BIOS ta có thể hiểu đây là chương trình cổ điển được nạp sẵn trong bo mạch chủ của máy tính (ví dụ: NVRAM)
 Quá trình này kiểm tra các thông số cần thiết của phần cứng ngoài ra cho phép ta thay đổi thiết lập cũng như cấu hình của nó, với UEFI (Unified Extensible Firmware Interface) đây là tiêu chuẩn mới dần được thay thế cho BIOS.
 
 - BIOS: 
  + Với máy tính sử dụng `system firmware` chuẩn BIOS, BIOS sẽ tìm đến MBR (Master Boot Record).
  + `MBR` chứa các thông tin cho quá trình khởi động và vị trí phân vùng khởi động (vd ổ cứng), chịu trách nhiệm cho việc tìm và nạp nhân hệ điều hành.
 - UEFI:
  + Cũng giống như BIOS, UEFI là một chương trình nằm trên phần cứng của máy tính. Thay vì được lưu trong firmware giống như BIOS, chương trình này được lưu trữ ở thư mục `/efi/`
  + UEFI sử dụng bảng phân vùng GUID (Globally Unique IDentifier) để định danh phần vùng khởi động
  + Khác với BIOS, UEFI thông tin các phân vùng được lưu ở thư mục `/efi/` trên 1 phân vùng gọi là phân vùng bảo đảm.
Có một sự so sánh như sau
BIOS sử dụng bản ghi MBR tương thích ở mỗi đầu ổ đĩa để định danh phân vùng boot, 
đối với UEFI tất cả thông tin được lưu trong bảng phần vùng, máy tính sẽ  sử dụng bản này để chạy quá trình boot tương ứng với phân vùng boot được định danh.
Ngày nay, UFEI đang dần trở thành tiêu chuẩn cho các hệ thống Linux và dần thay thế cho BIOS.

** Boot Loaders (bộ tải khởi động)
 Với việc BIOS kiểm tra thông số cần thiết của phần cứng và xác định phân vùng khởi động thành công.
 Máy tính sẽ làm công việc tiếp theo là `Boot Loaders'
 Boot loaders cũng là một chương trình có nhiệm vụ định danh lựa chọn nhân của hệ điều hành máy tính để khởi động. Boot loader sẽ nạp nhân này và bộ nhớ và chuyển quyền điều khiển máy tính cho nhân (kernel) này.
 Có một số Boot Loader phổ biến trên Linux là GRUB hay UNIX là FreeBSD
 Trong bài viết này em xin phép chỉ được nhắc đến GRUB
 
 - ** GRUB **
  - GRUB là chương tình chứa các tham số để khởi động máy tính. (ví dụ bảng menu entry)
  - Với hệ thống dùng BIOS/MBR bộ tải khởi động nằm ở khu vực đầu tiên (các block đầu tiên) trên đĩa cứng. Giai đoạn này, bộ nạp khởi động kiểm tra bảng phân vùng và tìm một phân vùng có khả năng khởi động. Khi tìm thấy một phân vùng có khả năng khởi động, GRUB sẽ tìm kiếm bộ tải khởi động giai đoạn thứ hai để nạp nhân.
  - Giai đoạn 2 nằm trong /boot . Tệp chứa cấu hình của boot gọi là `grub.cfg` sẽ lưu trong `/boot/grub` hoặc `/boot/grub2`
  - Tệp `grub.cfg` cho phép chúng ta tùy biến tại /etc/default/grub với các tham số phổ biến như bảng dưới
 
  - Sau khi thay đổi ta chạy (run) update-grub hoặc grub2-mkconfig để tệp được dịch đến tệp `grub.cfg`
 
  - GRUB cũng có các dòng lệnh cơ bản như bảng dưới cho phép ta nhập khi quá trình này diễn ra
 
 - ** The UEFI path
  - Khác với BIOS dùng boot loader như GRUB, hệ thống UEFI tạo phân vùng EFI và cài đặt các đoạn mã khởi động theo đường dẫn mặc định là /boot/bootx64.efi
  - Với hệ thống sử dụng phương pháp EFI / UEFI, phần mềm UEFI đọc dữ liệu trình quản lý khởi động để xác định ứng dụng UEFI nào sẽ được khởi chạy và từ nơi nào.
  - Trong trạng thái đầu tiên, UEFI boot loader tìm phần vùng và nạp chương trình gọi là `UEFI loader` từ /boot/loader.efi .  Đến đây quy trình lại tương tự như với hệ thống BIOS sử dụng bootloader là GRUB
Sau khi qua trình tải và nạp nhân thành công, máy tính sẽ chạy tiến trình đầu tiên có định danh ID là 1 và được chạy với tên gọi là `init`. `init` là một tiến trình phân cấp (runlevel) và là cha của mọi tiến trình trong hệ thống linux 
`note: không được sử dụng lệnh kill với tiến trình này`
   - `init` có một số chế độ thông thường như sau:
    - Chế độ một người dùng, cho hệ thống đơn giản, không gắn kết, không có dịch vụ.
	- Chế độ đa người sử dụng, các hệ thống được liên kết và đã được cấu hình kết hợp với hệ thống cửa sổ và giao diện đồ họa để điều khiển,
	- Chế độ máy chủ, tương tư như chế độ đa người sử dụng nhưng không có giao diện đồ họa.
	- Các tác dụng của `init` : đặt tên máy tính, đặt múi giờ, kiểm tra đĩa cứng với lệnh fsck, xóa tệp tạm, cấu hình mạng, và đặt biệt là chạy một tập hợp lệnh hoặc các kịch bản có sẵn.
	
	- Phân cấp trong tiến trình `init` lưu tại /etc/initiab:
	 + Runlevel 0: Shutdown hệ thống.
	 + Runlevel 1: Level chỉ  dùng cho 1 tài khoản / 1 người dùng để sửa lỗi tập tin hệ thống hoặc thay đổi (ví dụ xóa mật khẩu root khi quên mật khẩu)
	 + Runlevel 2: Không sử dụng.
	 + Runlevel 3: Dùng cho nhiều người nhưng chỉ giao tiếp qua dòng lệnh (không có giao diện)
	 + Runlevel 4: Không sử dụng
	 + Runlevel 5: Level dùng cho nhiều người dùng và được cung cấp giao diện đồ họa.
	 + Runlevel 6: Level Reboot hệ thống.
	 
** Systemd ** 
- Để thay thế cho `init`, `systemd` với nhiều tính năng hơn được sử dụng phổ biết cho các hệ thống linux.
- `systemd` cũng là tiến trình đầu tiên trên hệ thống với ID = 1
- `systemd` có đầy đủ các tính năng như `init` không chỉ quản lý các tiến trình song song mà còn quản lý kết nối mạng `networkd`, kernel log `journald` và logins `logind`
- `systemd` sử dụng mục tiêu thay vì runlevel như `init`. Có 2 mục tiêu chính là multi-user.target và graphical.target
bảng dưới 
- `systemctl` là lệnh dùng để quản lý (bắt đầu, dừng, tải lại, kiểm tra trạng thái của dịch vụ nói cách khác `systemctl` là ứng dụng kiểm soát các dịch vụ của hệ thống\
VD: `systemctl start mysql`

Dưới đây là bảng so sánh phân cấp và target giữa `init` và `systemd`
 
 *Note*:  
	`Before the system is fully booted, filesystems must be checked and mounted and system
daemons started. These procedures are managed by a series of shell scripts (sometimes called
"init scripts") or unit files that are run in sequence by **init** or parsed by **systemd**.`

## 1.2 System Firmware
	- Device on motherboard such as SATA, network interface, USB...
## 1.3 BIOS vs UEFI std
 1. BIOS (Basic In / Out System)
	- Traditional PC firmware
	- BIOS relate Legacy BIOS
	- Boot with device starts with MBR (Master Boot Record)
 2. UEFI (or reversion of EFI)
	- use GPT disk partition (GUID Parition Table)
	- use FAT filesystems
	- use EFI System Part (ESP) at boot time
	- ESP available be mounted, read, written maintain by OS
	Note: *Not to run MBR-specific admin tool on GPT disk because BIOS system can't see the full GPT part table.
	- normal path
	`/efi/boot/bootx64.efi`
	or on ubuntu
	`/efi/ubuntu/grubx64.efi`
	- show config boot
	`efibootmgr -v`
## 1.4 Boot Loader
 - eg: GRUB
## 1.5 GRUB (Grand unified boot loader)
 - Original GRUB: GRUB Legacy
 - Extra-crispy GRUB 2 is **current standard** (for Ubuntu and RHEL)
 - Available to boot FreeBSD (UNIX) 
 - Stored system's NVRAM
 - It came from regular text file **grub.cfg**.
 Path 
 `/boot/grub` 
 or in RHEL and CentOS
 `/boot/grub2`
 - Available to create by yourself
 - Path
 `/etc/default/grub`
 - Modify or configure by **grub2-mkconfig**
 -GRUB config options **/etc/default/grub`.
 
 |shell               var|    Contents or function   |
 |-----------------------|---------------------------|
 |GRUB_BACKGROUND| Background image **must be .png, .tga, .jpg or .jpeg file**
 |GRUB_CMDLINE_LINUX| Kernel parameters to add |
 |GRUB_DEFAULT| Number or title of the menu entry|
 |GRUB_DISABLE_RECOVERY| Prevent the generation of recovery mode entries|
 |GRUB_PRELOAD_MODULES| List of GRUB modules to be loaded as early as possible|
 |GRUB_TIMEOUT| Second to display the boot menu before autoboot|
 
 - After modified, run `update-grub` or `grub2-mkconfig` 
 
 - Boot command:
 
 | CMD | Function |
 | --- | --- |
 | boot | Boot the system from specified kernel image |
 | help | Gets interactive help for a command |
 | linux | Loads a Linux kernel |
 | reboot | Reboots the system |
 | search | Searches devices by file, filesystem label, or UUID **need to be clear later**
 | usb | Tests USB support |
 
 - Linux kernel options -> * sepcify path to the* **init** or **systemd** *
## 1.6 FreeBSD boot process
 - **loader**
 - BIOS path called **boot0** instead **GRUB** in 
	- available adjusting with `boot0cfg` command
 - UEFI path 
	- path: `/boot/bootx64.efi`
 - loader configuration
 - loader command
## 1.7 System Management Daeamons (quản lý hệ thống background process)
###Tổng quan:
 - Tiến trình này được khởi chạy ngay khi kernel được load thành công
 - Chạy tự phát bởi kernel khởi động ngẫu nhiên, mỗi tiến trình mới được tạo ra từ tiến trình hiện có
 - Có thể list danh sách bằng lệnh `ps`
 - Là thành phần quan trọng để khởi tạo hệ thống
 - Chương trình đầu tiên được chạy có Process ID (PID) là 1 hay còn gọi tên là **init**
 - **init** đóng vai trò kích hoạt các file cấu hình hệ thống
  init:
	- Vai trò chính của init là tạo ra các process bằng chạy các chương trình được quy định
	- 3 mode init:
		1. Single-user mode: 
		2. Multi-user mode
		3. Server mode
	- **init** được thay thế bằng **systemd**
## 1.8 systemd chi tiết
 - systemd được chạy dưới nền và được cấu hình thành 1 file gọi là **unit**
 - Các thành phần của `systemd`:
	- `systemctl` quản lý trạng thái (bắt đầu chạy, dừng, khởi động lại)
	- `journald`  log hệ thống
	- `logind` quản lý truy cập của user
	- `networkd` quản lý kết nối mạng
	- `timedated` quản lý thời gian
	- `udev` quản lý thiết bị và firmware
	
 -  **unit** bao gồm 12 loại
	- service (các file quản lý hoạt động của 1 số chương trình)
	- socket (quản lý các kết nối)
	- device (quản lý thiết bị)
	- mount (gắn thiết bị)
	- automount (tự đống gắn thiết bị)
	- swap (vùng không gian bộ nhớ trên đĩa cứng)
	- target (quản lý tạo liên kết)
	- path (quản lý các đường dẫn)
	- timer (dùng cho cron-job để lập lịch)
	- snapshot (sao lưu)
	- slice (dùng cho quản lý tiến trình)
	- scope (quy định không gian hoạt động) 
 - **service trong systemd **
	- khởi động khi bật máy
	- chạy ở nền
	- được cấu hình ở các file riêng
	- quản lý bởi lệnh `systemctl`
			`start` : bật service
			`stop`	: tắt service
			`restart`
				eg: `$  sudo systemctl restart firewalld`
				